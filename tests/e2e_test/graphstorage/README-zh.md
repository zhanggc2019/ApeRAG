# GraphIndex E2E æµ‹è¯•å¥—ä»¶

æœ¬ç›®å½•åŒ…å« ApeRAG å›¾ç´¢å¼•æ¨¡å—çš„ç«¯åˆ°ç«¯æµ‹è¯•å¥—ä»¶ï¼Œç”¨äºéªŒè¯å„ç§å›¾å­˜å‚¨å®ç°çš„æ­£ç¡®æ€§å’Œä¸€è‡´æ€§ã€‚

## ğŸŒŸ ç‰¹è‰²äº®ç‚¹

### Test Oracle æµ‹è¯•æ¨¡å¼ âš–ï¸

æœ¬æµ‹è¯•å¥—ä»¶é‡‡ç”¨äº†**Test Oracle æ¨¡å¼**ï¼Œè¿™æ˜¯ä¸€ç§ä¼˜é›…ä¸”å¼ºå¤§çš„æµ‹è¯•æ–¹æ³•è®ºï¼š

- **åŒé‡éªŒè¯**: æ¯ä¸ªå›¾å­˜å‚¨å®ç°éƒ½ä¸ç»è¿‡éªŒè¯çš„ NetworkX åŸºçº¿å®ç°è¿›è¡Œæ¯”è¾ƒ
- **è‡ªåŠ¨åŒæ­¥**: Oracle è‡ªåŠ¨å°†æ‰€æœ‰å†™æ“ä½œåŒæ­¥åˆ°çœŸå®å­˜å‚¨å’ŒåŸºçº¿å­˜å‚¨
- **å³æ—¶éªŒè¯**: æ¯æ¬¡æŸ¥è¯¢æ“ä½œéƒ½ä¼šå®æ—¶æ¯”è¾ƒä¸¤ä¸ªå­˜å‚¨çš„ç»“æœï¼Œç¡®ä¿å®Œå…¨ä¸€è‡´
- **é›¶è¯¯å·®å®¹å¿**: ä»»ä½•ä¸ä¸€è‡´éƒ½ä¼šç«‹å³æŠ›å‡ºå¼‚å¸¸ï¼Œç¡®ä¿å®ç°çš„ä¸¥æ ¼æ­£ç¡®æ€§
- **çµæ´»æ¯”è¾ƒ**: æ”¯æŒæµ®ç‚¹æ•°å®¹å·®ã€å­—æ®µé¡ºåºæ— å…³æ€§ã€è¾¹æ–¹å‘è§„èŒƒåŒ–ç­‰æ™ºèƒ½æ¯”è¾ƒç­–ç•¥

è¿™ç§æ–¹æ³•ç¡®ä¿äº†æ¯ä¸ªå›¾å­˜å‚¨å®ç°éƒ½ç»è¿‡**ä¸¥æ ¼çš„è¡Œä¸ºéªŒè¯**ï¼Œé¿å…äº†å•çº¯ä¾èµ–é¢„æœŸç»“æœå¯èƒ½é—æ¼çš„è¾¹ç•Œæƒ…å†µã€‚

## ğŸ“ æ–‡ä»¶ç»“æ„

```
tests/e2e_test/graphindex/
â”œâ”€â”€ conftest.py                     # pytest é…ç½®
â”œâ”€â”€ graph_storage_oracle.py         # Test Oracle å®ç° âš–ï¸
â”œâ”€â”€ networkx_baseline_storage.py    # NetworkX åŸºçº¿å®ç°
â”œâ”€â”€ test_graph_storage.py           # é€šç”¨æµ‹è¯•å¥—ä»¶
â”œâ”€â”€ test_neo4j_storage.py           # Neo4j å­˜å‚¨æµ‹è¯•
â””â”€â”€ graph_storage_test_data.json    # æµ‹è¯•æ•°æ®
```

## ğŸ¯ æµ‹è¯•ç”¨ä¾‹è¦†ç›–

### èŠ‚ç‚¹æ“ä½œæµ‹è¯•
- `test_has_node` - èŠ‚ç‚¹å­˜åœ¨æ€§æ£€æŸ¥
- `test_get_node` - å•èŠ‚ç‚¹æ•°æ®è·å–
- `test_get_nodes_batch` - æ‰¹é‡èŠ‚ç‚¹è·å–
- `test_node_degree` - èŠ‚ç‚¹åº¦æ•°è®¡ç®—
- `test_node_degrees_batch` - æ‰¹é‡èŠ‚ç‚¹åº¦æ•°è®¡ç®—
- `test_upsert_node` - èŠ‚ç‚¹åˆ›å»º/æ›´æ–°
- `test_delete_node` - å•èŠ‚ç‚¹åˆ é™¤
- `test_remove_nodes` - æ‰¹é‡èŠ‚ç‚¹åˆ é™¤

### è¾¹æ“ä½œæµ‹è¯•
- `test_has_edge` - è¾¹å­˜åœ¨æ€§æ£€æŸ¥
- `test_get_edge` - å•è¾¹æ•°æ®è·å–
- `test_get_edges_batch` - æ‰¹é‡è¾¹è·å–
- `test_get_node_edges` - èŠ‚ç‚¹å…³è”è¾¹è·å–
- `test_get_nodes_edges_batch` - æ‰¹é‡èŠ‚ç‚¹å…³è”è¾¹è·å–
- `test_edge_degree` - è¾¹åº¦æ•°è®¡ç®—
- `test_edge_degrees_batch` - æ‰¹é‡è¾¹åº¦æ•°è®¡ç®—
- `test_upsert_edge` - è¾¹åˆ›å»º/æ›´æ–°
- `test_remove_edges` - æ‰¹é‡è¾¹åˆ é™¤

### å¤æ‚æ“ä½œæµ‹è¯•
- `test_data_integrity` - æ•°æ®å®Œæ•´æ€§éªŒè¯
- `test_large_batch_operations` - å¤§æ‰¹é‡æ“ä½œæ€§èƒ½
- `test_data_consistency_after_operations` - æ“ä½œåä¸€è‡´æ€§æ£€æŸ¥
- `test_get_all_labels` - æ‰€æœ‰æ ‡ç­¾è·å–
- `test_interface_coverage_summary` - æ¥å£è¦†ç›–ç‡æ€»ç»“

## ğŸ› ï¸ ç¯å¢ƒé…ç½®

### å¿…éœ€ç¯å¢ƒå˜é‡

#### Neo4j é…ç½®
```bash
NEO4J_HOST=127.0.0.1
NEO4J_PORT=7687
NEO4J_USERNAME=neo4j
NEO4J_PASSWORD=password
```

### ç¯å¢ƒå˜é‡é…ç½®æ–¹æ³•

1. **ä½¿ç”¨ .env æ–‡ä»¶** (æ¨è)
   ```bash
   # åœ¨é¡¹ç›®æ ¹ç›®å½•åˆ›å»º .env æ–‡ä»¶
   cp envs/env.template .env
   # ç¼–è¾‘ .env æ–‡ä»¶ï¼Œæ·»åŠ ä¸Šè¿°é…ç½®
   ```

2. **ä½¿ç”¨ç¯å¢ƒå˜é‡**
   ```bash
   export NEO4J_HOST=127.0.0.1
   export NEO4J_PORT=7687
   # ... å…¶ä»–å˜é‡
   ```

## ğŸš€ è¿è¡Œæµ‹è¯•

### è¿è¡Œæ‰€æœ‰ GraphIndex æµ‹è¯•
```bash
# åœ¨é¡¹ç›®æ ¹ç›®å½•æ‰§è¡Œ
uv run pytest tests/e2e_test/graphindex/ -v
```

### è¿è¡Œç‰¹å®šæ•°æ®åº“æµ‹è¯•

#### Neo4j å­˜å‚¨æµ‹è¯•
```bash
uv run pytest tests/e2e_test/graphindex/test_neo4j_storage.py::TestNeo4jStorage -v
```

### è¿è¡Œç‰¹å®šæµ‹è¯•ç”¨ä¾‹
```bash
# æµ‹è¯• Neo4j èŠ‚ç‚¹æ“ä½œ
uv run pytest tests/e2e_test/graphindex/test_neo4j_storage.py::TestNeo4jStorage::test_has_node -v
```

## ğŸ“Š æµ‹è¯•æ•°æ®

- **æ•°æ®æ–‡ä»¶**: `graph_storage_test_data.json`
- **æ•°æ®æ ¼å¼**: æ¯è¡Œä¸€ä¸ª JSON å¯¹è±¡ï¼ˆèŠ‚ç‚¹æˆ–è¾¹ï¼‰
- **æ•°æ®è§„æ¨¡**: åŒ…å«å¤§é‡çœŸå®å›¾æ•°æ®ï¼Œç¡®ä¿æµ‹è¯•çš„å…¨é¢æ€§
- **æ•°æ®æ¥æº**: ä»å®é™… LightRAG è¿è¡Œä¸­å¯¼å‡ºçš„å›¾ç»“æ„

## âš ï¸ æ³¨æ„äº‹é¡¹

### ç¯å¢ƒä¾èµ–
- å¦‚æœç¼ºå°‘å¯¹åº”æ•°æ®åº“çš„ç¯å¢ƒå˜é‡é…ç½®ï¼Œç›¸å…³æµ‹è¯•å°†**è‡ªåŠ¨è·³è¿‡**
- æµ‹è¯•ä¼šè‡ªåŠ¨æ£€æµ‹æ•°æ®åº“è¿æ¥å¯ç”¨æ€§
- å»ºè®®åœ¨éš”ç¦»ç¯å¢ƒä¸­è¿è¡Œï¼Œé¿å…å½±å“ç”Ÿäº§æ•°æ®

### æµ‹è¯•æ•°æ®ç®¡ç†
- æ¯ä¸ªæµ‹è¯•ç±»ä½¿ç”¨å”¯ä¸€çš„å·¥ä½œç©ºé—´ï¼ˆworkspaceï¼‰ï¼Œé¿å…å†²çª
- æµ‹è¯•ç»“æŸåä¼šè‡ªåŠ¨æ¸…ç†æµ‹è¯•æ•°æ®
- ä½¿ç”¨ `DROP SPACE/DATABASE` ç¡®ä¿å½»åº•æ¸…ç†

### æ€§èƒ½è€ƒè™‘
- å®Œæ•´æµ‹è¯•å¥—ä»¶éœ€è¦è¾ƒé•¿æ—¶é—´ï¼ˆæ¶‰åŠå¤§é‡æ•°æ®å¯¼å…¥ï¼‰
- å»ºè®®ä½¿ç”¨ SSD å­˜å‚¨æå‡ I/O æ€§èƒ½
- å¯ä»¥é€šè¿‡ `-k` å‚æ•°è¿è¡Œéƒ¨åˆ†æµ‹è¯•

## ğŸ”§ æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **æ•°æ®åº“è¿æ¥å¤±è´¥**
   ```bash
   # æ£€æŸ¥æ•°æ®åº“æœåŠ¡çŠ¶æ€
   docker ps | grep neo4j
   ```

2. **ç¯å¢ƒå˜é‡æœªè®¾ç½®**
   ```bash
   # éªŒè¯ç¯å¢ƒå˜é‡
   echo $NEO4J_HOST
   ```

3. **æµ‹è¯•æ•°æ®æ–‡ä»¶ç¼ºå¤±**
   ```bash
   # æ£€æŸ¥æµ‹è¯•æ•°æ®æ–‡ä»¶
   ls -la tests/e2e_test/graphindex/graph_storage_test_data.json
   ```

### è°ƒè¯•æ¨¡å¼
```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
uv run pytest tests/e2e_test/graphindex/ -v -s --log-cli-level=DEBUG
```

## ğŸ‰ æ‰©å±•æ–°çš„å­˜å‚¨å®ç°

è¦ä¸ºæ–°çš„å›¾å­˜å‚¨å®ç°æ·»åŠ æµ‹è¯•ï¼š

1. **å®ç°å­˜å‚¨æ¥å£**: ç»§æ‰¿ `BaseGraphStorage`
2. **åˆ›å»ºæµ‹è¯•æ–‡ä»¶**: å‚è€ƒ `test_neo4j_storage.py` çš„ç»“æ„
3. **é…ç½® Oracle**: ä½¿ç”¨ `GraphStorageOracle` åŒ…è£…ä½ çš„å®ç°
4. **è°ƒç”¨æµ‹è¯•å¥—ä»¶**: ç›´æ¥ä½¿ç”¨ `GraphStorageTestSuite` çš„é™æ€æ–¹æ³•

è¿™ç§è®¾è®¡ç¡®ä¿äº†**æ‰€æœ‰å­˜å‚¨å®ç°éƒ½ä½¿ç”¨ç›¸åŒçš„æµ‹è¯•æ ‡å‡†**ï¼Œä¿è¯äº† API çš„ä¸€è‡´æ€§å’Œå¯é æ€§ã€‚

---

**Test Oracle æ¨¡å¼è®©æˆ‘ä»¬å¯¹å›¾å­˜å‚¨å®ç°çš„æ­£ç¡®æ€§å……æ»¡ä¿¡å¿ƒï¼** âš–ï¸âœ¨ 